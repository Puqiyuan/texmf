\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{wx672common}

\RequirePackage{ifxetex} % This class can only be processed with XeTeX

\RequirePackage{graphicx}
\graphicspath{{./figs/}{../figs/}{./img/}{./}{../}} %note that the trailing “/” is required

\RequirePackage{latexsym,pifont,units,amsmath,amsfonts,amssymb,marvosym,mathtools}

\RequirePackage[tt=false]{libertine} % keyboard symbol

\RequirePackage[font=footnotesize,labelfont=bf]{caption}

\RequirePackage{multicol,rotating,tabu,varwidth,ulem,etoolbox,longtable,comment}

%%%% use ulem instead since it can work with xeCJK
% \RequirePackage{soul}
% \setul{1.5pt}{.4pt}% 1.5pt below contents
% \setulcolor{gray}

\RequirePackage{xltxtra} %fontspec,xunicode are loaded here.
\defaultfontfeatures{Mapping=tex-text}
\setsansfont{DejaVu Sans}
\setmainfont{DejaVu Serif}

\RequirePackage{xeCJK}
\xeCJKDeclarePunctStyle{ condensed }
{
  min-bound-to-kerning    = true,%控制相邻两标点之间的空白宽度。
  kerning-margin-minimum  = .2em,%相邻两个标点之间的最小空白宽度。
}
\xeCJKsetup{PunctStyle=condensed}
\xeCJKsetwidth{“”《》、（）}{1.2ex}
\xeCJKsetkern{：}{（}{1ex}
\xeCJKsetkern{；}{（}{1ex}
\xeCJKsetkern{。}{“}{1ex}
\xeCJKsetkern{。}{《}{1.5ex}

\setCJKmainfont[BoldFont={Adobe Heiti Std}]{Adobe Song Std}
\setCJKsansfont{Noto Sans CJK SC Regular}
\setCJKmonofont{Noto Sans Mono CJK SC Regular}
\setCJKfamilyfont{hei}{Adobe Heiti Std}
\setCJKfamilyfont{song}{Adobe Song Std}
\setCJKfamilyfont{kai}{Adobe Kaiti Std} % e.g. \CJKfamily{kai}

\newfontfamily\humor{Humor Sans}
\newfontfamily\purisa{Purisa}
\newfontfamily\dejavu{DejaVu Sans Mono}
\newCJKfontfamily\quotefont{Adobe Kaiti Std}

\newcommand{\ziju}[1]{\renewcommand{\CJKglue}{\hskip #1}}

\renewcommand{\uline}[1]{\CJKunderline-[depth=0.2em,format=\color{black}]{#1}}
\renewcommand{\uwave}[1]{\CJKunderwave-[depth=0.2em,format=\color{black}]{#1}}
\newcommand{\udot}[1]{\CJKunderdot[depth=0.2em,format=\color{black}]{#1}}

% adjust the spaces between numbers and Chinese characters
\xeCJKsetup{xCJKecglue=\hskip 0pt plus 0.08\baselineskip}

\RequirePackage{xcolor} % must before hyperref
\definecolor{Green}{cmyk}{1,0,1,.4}

\RequirePackage[xetex,bookmarksnumbered,pdfpagelabels=true,plainpages=false,colorlinks=true,
linkcolor=black,citecolor=black,urlcolor=blue]{hyperref}

\RequirePackage{parskip} % not sure if this is needed

\RequirePackage[onehalfspacing]{setspace}
\renewcommand{\doublespacing}{\setstretch{1.6}}
\renewcommand{\singlespacing}{\setstretch{1.2}}
\renewcommand{\onehalfspacing}{\setstretch{1.4}}

\setlength{\parindent}{2em}

%\overfullrule=2cm % for easy finding the overfull lines

% fixing overfull in list-of-figures.
%http://tex.stackexchange.com/questions/127643/fix-formatting-errors-of-page-number-99-in-table-of-contents
\makeatletter
\renewcommand*\@pnumwidth{2em}
\makeatother

%%%%% biblatex %%%%%
\RequirePackage[backend=biber,url=true,hyperref=true,
style=caspervector,utf8,sorting=centy,% for chinese
doi=false,isbn=false]{biblatex}

\renewcommand*{\bibfont}{\small} % 11pt
\DeclareFieldFormat*{year}{#1} % adjust caspervector to show year in non-bold style.

\newbibmacro{string+url}[1]{%
  \iffieldundef{url}{#1}{\href{\thefield{url}}{#1}}}
\DeclareFieldFormat{title}{\usebibmacro{string+url}{\mkbibemph{#1}}}
\DeclareFieldFormat[article]{title}{\usebibmacro{string+url}{\mkbibquote{#1}}}

%%%%% caspervector provides \supercite already.
% supercite
% \DeclareCiteCommand{\supercite}[\mkbibsuperscript]
% {\iffieldundef{prenote}
%   {}
%   {\BibliographyWarning{Ignoring prenote argument}}%
%   \iffieldundef{postnote}
%   {}
%   {\BibliographyWarning{Ignoring postnote argument}}}
% {\usebibmacro{citeindex}%
%   \bibopenbracket\usebibmacro{cite}\bibclosebracket}
% {\supercitedelim}
% {}
\let\cite=\supercite

%%%%% end biblatex %%%%%

\RequirePackage[bottom]{footmisc} % stick footnote at bottom of page

%%%%% minted %%%%%
\RequirePackage{minted} % minted has to be loaded at last!!!
\usemintedstyle{bw}

\renewcommand{\theFancyVerbLine}{
  \textcolor{lightgray}{\scriptsize \arabic{FancyVerbLine}}}
\newminted{gas}{ linenos=true,numbersep=2pt,fontsize=\footnotesize,
  frame=leftline,framesep=3pt,rulecolor=\color{lightgray}, xleftmargin=10pt }
\newminted{c}{ linenos=true,numbersep=2pt,fontsize=\footnotesize,
  frame=leftline,framesep=3pt,rulecolor=\color{lightgray}, xleftmargin=10pt }
\newminted{python}{ linenos=true,numbersep=2pt,fontsize=\footnotesize,
  frame=leftline,framesep=3pt,rulecolor=\color{lightgray}, xleftmargin=10pt }
\newcommand{\codec}[1]{\mintinline{c}|#1|}

%%%%% end minted %%%%%

\DeclareOption{cn}{
  \renewcommand{\contentsname}{目\hspace{1em}录}
  \renewcommand{\listfigurename}{插图目录}
  \renewcommand{\listtablename}{表格目录}
  \renewcommand{\figurename}{图}
  \renewcommand{\tablename}{表}
  \renewcommand{\appendixname}{附\hspace{1em}录}
  \renewcommand{\indexname}{索\hspace{1em}引}
  \renewcommand{\listingscaption}{程序} % used by minted
  \renewcommand{\listoflistingscaption}{程序目录}
}

\ProcessOptions\relax

% use C-x 8 RET to input utf8 symbols
\newfontfamily\MyEmoji{Symbola}
\newcommand\Symbol[1]{\MyEmoji #1}
\newcommand\good{\MyEmoji ☺}
\newcommand\bad{\MyEmoji ☹}
\newcommand\danger{\MyEmoji ☠}
\newcommand\pointright{\MyEmoji ☞}

\newcommand{\cfbox}[2]{%
  \colorlet{currentcolor}{.}%
  {\color{#1}\fbox{\color{currentcolor}#2}}%
}
\newcommand{\code}[1]{\texttt{\textcolor{violet}{#1}}}
\newcommand{\Navy}[1]{\textcolor{Navy}{#1}}

